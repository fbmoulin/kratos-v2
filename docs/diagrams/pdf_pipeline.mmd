flowchart TD
    A["ğŸ“¤ Upload do PDF<br/>pelo UsuÃ¡rio"] --> B["âš¡ API recebe<br/>o arquivo"]
    B --> C["ğŸ“¦ Salva no<br/>Supabase Storage"]
    B --> D["ğŸ—„ï¸ Cria registro<br/>status: pending"]
    B --> E["ğŸ“¨ Enfileira job<br/>no Redis"]
    
    E --> F["âš™ï¸ Worker Celery<br/>consome o job"]
    
    F --> G{"Tipo de<br/>conteÃºdo?"}
    
    G -->|"Texto e Estrutura"| H["ğŸ“„ Docling (IBM)<br/>ExtraÃ§Ã£o Estrutural"]
    G -->|"Tabelas"| I["ğŸ“Š pdfplumber<br/>ExtraÃ§Ã£o de Tabelas"]
    G -->|"Imagens/GrÃ¡ficos"| J["ğŸ‘ï¸ Gemini 2.5 Flash<br/>Vision API"]
    
    H --> K["ğŸ”— Merge dos<br/>Resultados"]
    I --> K
    J --> K
    
    K --> L{"ValidaÃ§Ã£o<br/>Pydantic"}
    
    L -->|"âœ… VÃ¡lido"| M["ğŸ—„ï¸ Salva na tabela<br/>extractions"]
    L -->|"âŒ InvÃ¡lido"| N["ğŸ”„ Retry com<br/>fallback"]
    
    M --> O["ğŸ“ Atualiza status:<br/>completed"]
    N --> P["ğŸ“ Atualiza status:<br/>failed"]
    
    O --> Q["ğŸ”” Notifica Frontend<br/>WebSocket / Polling"]
    P --> Q
    
    style A fill:#4CAF50,color:#fff
    style L fill:#FF9800,color:#fff
    style M fill:#2196F3,color:#fff
    style P fill:#f44336,color:#fff
