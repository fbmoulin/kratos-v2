name: Deploy Production

on:
  push:
    tags: ['v*']

concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  test:
    name: Pre-deploy Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup project
        uses: ./.github/actions/setup-kratos

      - run: pnpm build

      - name: Run tests
        run: |
          pnpm --filter @kratos/core test
          pnpm --filter @kratos/db test
          pnpm --filter @kratos/ai test
          pnpm --filter @kratos/api test
          pnpm --filter @kratos/web test
        env:
          NODE_ENV: test

  deploy-web:
    name: Deploy Web (Vercel Production)
    needs: test
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4

      - name: Setup project
        uses: ./.github/actions/setup-kratos

      - name: Build web
        run: pnpm --filter @kratos/web build
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
          VITE_API_BASE_URL: ${{ secrets.PRODUCTION_API_URL }}
          VITE_SENTRY_DSN: ${{ secrets.VITE_SENTRY_DSN }}

      - name: Deploy to Vercel (Production)
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'
          working-directory: apps/web

  deploy-api:
    name: Deploy API (Railway Production)
    needs: test
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Deploy API to Railway
        run: railway up --service kratos-api --detach
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_PRODUCTION_TOKEN }}

  deploy-worker:
    name: Deploy PDF Worker (Railway Production)
    needs: test
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Deploy Worker to Railway
        run: railway up --service kratos-pdf-worker --detach
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_PRODUCTION_TOKEN }}
